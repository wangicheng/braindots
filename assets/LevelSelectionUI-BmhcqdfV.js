import{C as p,G as x,g as k,a as z,U as T,s as e,L as B,T as S,b as J,c as ct,d as wt,O as vt,F as bt,N as It,I as At,e as St,S as mt,f as Ft,B as Tt,h as dt,P as xt,D as yt,i as Pt}from"./Game-CdeDPlkv.js";import{LanguageManager as P}from"./LanguageManager-BhWXvVLp.js";import"./index-CcEOQSjg.js";class Bt extends p{onClose;currentView="list";overlay;card;constructor(t){super(),this.onClose=t,this.overlay=new x,this.card=new p,this.addChild(this.overlay),this.addChild(this.card),this.refreshUI(),window.addEventListener("resize",this.handleResize),P.getInstance().subscribe(this.handleLanguageChange)}handleLanguageChange=()=>{this.refreshUI()};handleResize=()=>{this.refreshUI()};refreshUI(){const t=k(),s=z();this.overlay.clear(),this.overlay.rect(0,0,t,s),this.overlay.fill({color:0,alpha:.5}),this.overlay.eventMode="static",this.overlay.cursor="default",this.overlay.off("pointertap",this.onClose),this.overlay.on("pointertap",this.onClose),this.card.removeChildren();const n=e(600),i=e(500),r=(t-n)/2,o=(s-i)/2;this.card=T.createCard(n,i,16777215,0),this.card.position.set(r,o),this.addChild(this.card),this.card.eventMode="static",this.card.on("pointertap",a=>a.stopPropagation()),this.currentView==="list"?this.drawListView(n):this.currentView==="profile"?this.drawProfileView(n):this.currentView==="language"&&this.drawLanguageView(n)}drawListView(t){const s=c=>P.getInstance().t(c),n={title:s("settings.title"),showBack:!1};this.drawHeader(t,n);const i=e(100),r=e(60),o=t-e(40),a=e(20);[{label:s("settings.profile"),onClick:()=>this.setView("profile"),icon:""},{label:s("settings.language"),onClick:()=>this.setView("language"),icon:""},{label:s("settings.github"),onClick:()=>{window.open("https://github.com/wangicheng/opendots","_blank")},icon:""}].forEach((c,l)=>{const g=i+l*(r+e(10)),I=this.createListItem(c.label,c.icon,o,r,c.onClick);I.container.position.set(a,g),this.card.addChild(I.container)})}drawProfileView(t){const s=w=>P.getInstance().t(w);this.drawHeader(t,{title:s("profile.title"),showBack:!0,onBack:()=>this.setView("list")});const n=B.getInstance(),i=n.isLoggedIn(),r=n.getUserProfile(),o=t/2;if(!i||!r){const w=new S({text:s("auth.signin_prompt"),style:{fontFamily:"Arial",fontSize:e(16),fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:t-e(80)}});w.anchor.set(.5),w.position.set(o,e(150)),this.card.addChild(w);const v=e(250),m=e(50),b=new p,F=new x;F.roundRect(-v/2,-m/2,v,m,m/2),F.fill(16777215),F.stroke({width:1,color:13421772});const y=new S({text:s("auth.signin_google"),style:{fontFamily:"Arial",fontSize:e(18),fill:"#555555",fontWeight:"bold"}});y.anchor.set(.5),b.addChild(F),b.addChild(y),b.position.set(o,e(250)),b.eventMode="static",b.cursor="pointer",b.on("pointertap",()=>{n.loginWithGoogle("")}),this.card.addChild(b);return}const a=e(120),h=e(50),c=T.createAvatar(h,r.avatarUrl,r.avatarColor,14737632);c.position.set(o,a),this.card.addChild(c);const l=a+h+e(40),g=new S({text:r.name,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});g.anchor.set(.5),g.position.set(o,l),this.card.addChild(g);const I=l+e(60),f=new p,d=e(120),u=e(40),C=new x;C.roundRect(-d/2,-u/2,d,u,u/2),C.fill(16772846),C.stroke({width:1,color:16711680});const A=new S({text:s("auth.logout"),style:{fontFamily:"Arial",fontSize:e(16),fill:"#FF0000"}});A.anchor.set(.5),f.addChild(C),f.addChild(A),f.position.set(o,I),f.eventMode="static",f.cursor="pointer",f.on("pointertap",()=>{n.logout(),this.refreshUI()}),this.card.addChild(f)}drawLanguageView(t){const s=l=>P.getInstance().t(l);this.drawHeader(t,{title:s("language.title"),showBack:!0,onBack:()=>this.setView("list")});const i=P.getInstance().getAvailableLanguages().map(l=>({code:l,label:s(`language.${l}`)})),r=e(100),o=e(60),a=t-e(40),h=e(20),c=P.getInstance().getCurrentLanguage();i.forEach((l,g)=>{const I=r+g*(o+e(10)),f=l.code===c,d=f?"":"",u=this.createListItem(l.label,d,a,o,()=>{P.getInstance().setLanguage(l.code)});if(u.container.position.set(h,I),f){u.bg.clear();const C=o/2;u.bg.roundRect(0,0,a,o,C),u.bg.stroke({width:2,color:3646697}),u.bg.fill(15792383),u.icon.style.fill="#37A4E9"}u.chevron.visible=!1,this.card.addChild(u.container)})}drawHeader(t,s){const n=e(60),i=new S({text:s.title,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});if(i.anchor.set(.5),i.position.set(t/2,n/2),this.card.addChild(i),s.showBack&&s.onBack){const o=new p,a=new x;a.rect(0,0,e(40),e(40)),a.fill({color:16777215,alpha:.001}),o.addChild(a);const h=T.createIcon("",e(24),"#555555");h.anchor.set(.5),h.position.set(e(20),e(20)+e(2)),o.addChild(h),o.position.set(e(10),(n-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",s.onBack),this.card.addChild(o)}else if(!s.showBack){const o=new p,a=new x;a.rect(0,0,e(40),e(40)),a.fill({color:16777215,alpha:.001}),o.addChild(a);const h=new S({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});h.anchor.set(.5),h.position.set(e(20),e(20)+e(2)),o.addChild(h),o.position.set(t-e(50),(n-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",this.onClose),this.card.addChild(o)}const r=new x;r.rect(0,n,t,1),r.fill(15658734),this.card.addChild(r)}createListItem(t,s,n,i,r){const o=new p,a=T.createPill(n,i,16382457);o.addChild(a);const h=T.createIcon(s,e(20),"#555555");h.anchor.set(.5),h.position.set(e(30),i/2+e(2)),o.addChild(h);const c=new S({text:t,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});c.anchor.set(0,.5),c.position.set(e(60),i/2),o.addChild(c);const l=T.createIcon("",e(16),"#CCCCCC");return l.anchor.set(.5),l.position.set(n-e(20),i/2+e(2)),o.addChild(l),o.eventMode="static",o.cursor="pointer",o.on("pointertap",r),{container:o,bg:a,icon:h,label:c,chevron:l}}setView(t){this.currentView=t,this.refreshUI()}destroy(t){window.removeEventListener("resize",this.handleResize),P.getInstance().unsubscribe(this.handleLanguageChange),super.destroy(t)}}class Lt extends p{onCloseCallback;onViewLevelsCallback;onLikeToggleCallback;onDeleteCallback;allowDelete;levelData;userColor;getThumbnail;authorLevelCount;constructor(t,s,n,i,r,o,a,h=!1,c=0){super(),this.levelData=t,this.userColor=s,this.getThumbnail=n,this.onCloseCallback=i,this.onViewLevelsCallback=r,this.onLikeToggleCallback=o,this.onDeleteCallback=a,this.allowDelete=h,this.authorLevelCount=c,this.refreshUI(),window.addEventListener("resize",this.handleResize)}handleResize=()=>{this.refreshUI()};refreshUI(){this.removeChildren();const t=k(),s=z();this.zIndex=2e3;const n=T.createOverlay(t,s,.5);n.eventMode="static",n.cursor="pointer",n.on("pointertap",()=>this.onCloseCallback()),this.addChild(n);const i=e(800),r=e(40),o=e(20),a=i-r*2-o,h=a*.6,c=a*.4,l=h,g=l*(9/16),I=e(80),f=g+I+r*2,d=T.createCard(i,f,16777215);d.position.set((t-i)/2,(s-f)/2),this.addChild(d),d.eventMode="static",d.on("pointertap",W=>W.stopPropagation());const u=new p;u.position.set(r,r),d.addChild(u);const C=new p,A=T.createShadow(l,g,0,8,.3);C.addChild(A);const w=new x;w.rect(0,0,l,g),w.fill(16119285),w.stroke({width:1,color:15658734}),C.addChild(w);const v=new x;v.rect(0,0,l,g),v.fill(16777215),C.addChild(v);const m=this.getThumbnail(l,g);m.mask=v,C.addChild(m),u.addChild(C);const b=new p;b.position.set(0,g+e(15)),u.addChild(b);const F=new p;b.addChild(F);const y=W=>P.getInstance().t(W),M=new J({fontFamily:"Arial",fontSize:e(14),fill:"#888888"}),V=new J({fontFamily:"Arial",fontSize:e(14),fontWeight:"bold",fill:"#555555"}),U=(W,Ct,pt)=>{const q=new p,lt=new S({text:W,style:M}),ht=new S({text:Ct,style:V});return ht.x=lt.width+e(5),q.addChild(lt,ht),q.y=pt,q},_=this.levelData.isPublished?new Date(this.levelData.createdAt||Date.now()).toLocaleDateString():this.levelData.createdAt?new Date(this.levelData.createdAt).toLocaleDateString():"-",L=this.levelData.isPublished?y("level.published"):y("level.created");F.addChild(U(L,_,0));const H=this.levelData.attempts??0;F.addChild(U(y("level.attempts"),H.toString(),e(25)));const Z=this.levelData.clears??0,gt=H>0?Math.round(Z/H*100):0;F.addChild(U(y("level.clears"),`${Z} (${gt}%)`,e(50)));const tt=e(100),et=e(36),it=this.createLikeButton(this.levelData.likes||0,tt,et);it.position.set(l-tt,(e(75)-et)/2),b.addChild(it);const E=new p;E.position.set(r+h+o,r),d.addChild(E);const st=g+I,D=c,ut=T.createCard(D,st,16777215);E.addChild(ut);const O=D/2,N=e(70);let X=e(30),nt=this.userColor,ot;if(this.levelData.authorId===ct){const W=B.getInstance().getUserProfile();W&&(nt=W.avatarColor,ot=W.avatarUrl)}const rt=T.createAvatar(N,ot,nt);rt.position.set(O,X+N),E.addChild(rt),X+=N*2+e(15);const ft=this.levelData.author||P.getInstance().t("common.unknown"),Y=new S({text:ft,style:{fontFamily:"Arial",fontSize:e(20),fontWeight:"bold",fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:D-e(20)}});Y.anchor.set(.5,0),Y.position.set(O,X),E.addChild(Y),X+=Y.height+e(5);const $=new S({text:y("profile.total_levels")+this.authorLevelCount.toString(),style:{fontFamily:"Arial",fontSize:e(14),fill:"#AAAAAA",align:"center"}});$.anchor.set(.5,0),$.position.set(O,X),E.addChild($);const at=this.levelData.authorId===ct&&this.allowDelete?this.createDeleteButton(D-e(40)):this.createViewLevelsButton(D-e(40));at.position.set(O,st-e(30)),E.addChild(at);const R=new p,G=e(40),j=new x;j.rect(0,0,G,G),j.fill({color:16777215,alpha:.001}),R.addChild(j);const K=new S({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});K.anchor.set(.5),K.position.set(G/2,G/2),R.addChild(K),R.position.set(i-G-e(5),e(5)),R.eventMode="static",R.cursor="pointer",R.on("pointertap",()=>this.onCloseCallback()),d.addChild(R)}createLikeButton(t,s,n){const i=new p,r=s,o=n||e(36),a=o/2,h=T.createPill(r,o,16777215,16739179,2);i.addChild(h);const c=T.createIcon("",e(20),"#FF6B6B");i.addChild(c);let l=t;const g=new S({text:l.toString(),style:{fontFamily:"Arial",fontSize:e(24),fill:"#FF6B6B",fontWeight:"bold"}});g.anchor.set(0,.5),i.addChild(g);const I=()=>{const C=e(12),A=c.width+C+g.width,w=(r-A)/2;c.position.set(w+c.width/2,o/2+e(2)),g.position.set(w+c.width+C,o/2)};I(),i.eventMode="static",i.cursor="pointer";let f=!!this.levelData.isLikedByCurrentUser;const d=f?t-1:t,u=()=>{const C=d+(f?1:0);g.text=C.toString(),I(),f?(h.clear(),h.roundRect(0,0,r,o,a),h.fill({color:16739179}),c.style.fill="#FFFFFF",g.style.fill="#FFFFFF"):(h.clear(),h.roundRect(0,0,r,o,a),h.stroke({width:2,color:16739179}),h.fill({color:16777215}),c.style.fill="#FF6B6B",g.style.fill="#FF6B6B")};return u(),i.on("pointertap",()=>{f=!f,this.levelData.isLikedByCurrentUser=f,this.levelData.likes=d+(f?1:0),this.onLikeToggleCallback&&this.onLikeToggleCallback(),u()}),i}createViewLevelsButton(t){const s=t,n=e(36),i=T.createButton(P.getInstance().t("profile.view_levels"),s,n,3646697,"#FFFFFF",()=>{this.levelData.authorId&&this.onViewLevelsCallback(this.levelData.authorId)},14);return i.pivot.set(s/2,n/2),i}createDeleteButton(t){const s=t,n=e(36),i=new p,r=T.createPill(s,n,16777215,16739179,1);r.position.set(-s/2,-n/2),i.addChild(r);const o=new S({text:P.getInstance().t("level.delete"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#FF6B6B",fontWeight:"bold"}});return o.anchor.set(.5),i.addChild(o),i.eventMode="static",i.cursor="pointer",i.on("pointertap",()=>{if(this.onDeleteCallback){const a=new wt(P.getInstance().t("level.delete_confirm"),()=>{this.onDeleteCallback&&this.onDeleteCallback(this.levelData.id),this.removeChild(a),a.destroy()},()=>{this.removeChild(a),a.destroy()},{confirmKey:"level.delete",cancelKey:"common.cancel"});this.addChild(a)}}),i}destroy(t){window.removeEventListener("resize",this.handleResize),super.destroy(t)}}class Wt extends p{levels;onSelect;onCreate;currentPage=0;totalPages=0;laserTexture;gridContainer;headerContainer;isDragging=!1;dragStartX=0;dragStartPageX=0;dragDistance=0;scrollTweenId=0;penSelectionUI=null;settingsUI=null;userProfileCard=null;onPenSelect;currentPenId="pen_default";sortMode="latest";filterAuthorId=null;visibleLevels=[];filterAuthorName=null;filterAuthorColor=8947848;latestBtnText;popularBtnText;mineBtnText;filterFilterTagContainer;createLevelBtn;HEADER_HEIGHT_RATIO=1/5;COLS=3;ROWS=2;ITEMS_PER_PAGE=6;CARD_ASPECT_RATIO=16/9;backgroundHitArea=null;constructor(t,s,n,i,r,o){super(),this.levels=t,this.onSelect=s,this.onCreate=n,this.laserTexture=i,this.onPenSelect=r,o&&(this.currentPenId=o),this.totalPages=Math.ceil(t.length/this.ITEMS_PER_PAGE),this.headerContainer=new p,this.gridContainer=new p,this.addChild(this.gridContainer),this.addChild(this.headerContainer),this.setupHeader(),this.refreshVisibleLevels(),this.setupInteraction(),P.getInstance().subscribe(()=>{this.headerContainer.removeChildren(),this.setupHeader(),this.setupGrid()})}setupHeader(){const t=A=>P.getInstance().t(A),s=k(),n=this.getHeaderHeight(),i=new J({fontFamily:"Arial",fontSize:e(60),fontWeight:"bold",fill:"#555555"}),r=new S({text:t("app.title"),style:i});r.position.set(e(60),(n-r.height)/2),this.headerContainer.addChild(r);const o=(n+e(10))/2;this.latestBtnText=this.createSortButton(t("sort.latest"),0,o,"latest"),this.headerContainer.addChild(this.latestBtnText),this.popularBtnText=this.createSortButton(t("sort.popular"),0,o,"popular"),this.headerContainer.addChild(this.popularBtnText),this.mineBtnText=this.createHeaderInteractiveText(t("sort.mine"),0,o,()=>{const A=B.getInstance().getUserProfile()?.id;A&&(this.filterAuthorId===A?this.setFilterAuthor(null):this.setFilterAuthor(A))}),this.headerContainer.addChild(this.mineBtnText);const a=e(40),h=this.latestBtnText.width+a+this.popularBtnText.width+a+this.mineBtnText.width,c=(s-h)/2;this.latestBtnText.x=c,this.popularBtnText.x=c+this.latestBtnText.width+a,this.mineBtnText.x=c+this.latestBtnText.width+a+this.popularBtnText.width+a,this.filterFilterTagContainer=new p,this.filterFilterTagContainer=new p,this.headerContainer.addChild(this.filterFilterTagContainer),this.updateFilterTag();const l=e(36),g=e(52),I=e(20),f=this.createHeaderButton(""),d=s-e(20)-g;f.position.set(d,l),f.on("pointertap",()=>this.showSettings()),this.headerContainer.addChild(f);const u=this.createHeaderButton(""),C=d-I-g;u.position.set(C,l),u.on("pointertap",()=>this.showPenSelection()),this.headerContainer.addChild(u),this.createLevelBtn=this.createFloatingActionButton(),this.createLevelBtn.visible=!1,this.addChild(this.createLevelBtn),this.updateSortButtons()}getHeaderHeight(){return z()*this.HEADER_HEIGHT_RATIO}createFloatingActionButton(){const t=e(64),s=new p,n=new x;n.circle(0,0,t/2),n.fill(5592405),s.addChild(n);const i=new S({text:"+",style:{fontFamily:"Arial",fontSize:e(40),fill:"#FFFFFF",fontWeight:"bold"}});return i.anchor.set(.5),i.position.set(0,0),s.addChild(i),s.position.set(k()-e(50),z()-e(50)),s.eventMode="static",s.cursor="pointer",s.on("pointertap",()=>{console.log("Create Level Attempt"),this.onCreate()}),s}createSortButton(t,s,n,i){return this.createHeaderInteractiveText(t,s,n,()=>{this.setSortMode(i)})}createHeaderInteractiveText(t,s,n,i){const r=new S({text:t,style:{fontFamily:"Arial",fontSize:e(24),fill:"#AAAAAA",fontWeight:"normal"}});return r.anchor.set(0,.5),r.position.set(s,n),r.eventMode="static",r.cursor="pointer",r.on("pointertap",i),r}updateSortButtons(){const t=B.getInstance().getUserProfile()?.id,s=this.filterAuthorId===t&&!!t;if(this.latestBtnText){const n=this.sortMode==="latest"&&!s;this.latestBtnText.style.fill=n?"#555555":"#AAAAAA",this.latestBtnText.style.fontWeight=n?"bold":"normal"}if(this.popularBtnText){const n=this.sortMode==="popular"&&!s;this.popularBtnText.style.fill=n?"#555555":"#AAAAAA",this.popularBtnText.style.fontWeight=n?"bold":"normal"}if(this.mineBtnText){const n=s;this.mineBtnText.style.fill=n?"#555555":"#AAAAAA",this.mineBtnText.style.fontWeight=n?"bold":"normal"}this.createLevelBtn&&(this.createLevelBtn.visible=!!t)}createHeaderButton(t){const s=e(52),n=new p,i=new x;i.rect(0,0,s,s),i.fill({color:16777215,alpha:.001}),n.addChild(i);const r=T.createIcon(t,e(60),"#555555");return r.style.stroke={color:"#555555",width:.5},r.position.set(s/2,s/2+e(2)),n.addChild(r),n.eventMode="static",n.cursor="pointer",n}setupGrid(){this.gridContainer.removeChildren();const t=k();for(let s=0;s<this.totalPages;s++){const n=new p;n.x=s*t,this.gridContainer.addChild(n);const i=s*this.ITEMS_PER_PAGE,r=Math.min(i+this.ITEMS_PER_PAGE,this.visibleLevels.length);this.renderPage(n,i,r)}}renderPage(t,s,n){const i=k(),r=z(),o=this.getHeaderHeight(),a=i,h=r-o,c=a*.7/this.COLS,l=Math.floor(c),g=Math.floor(l/this.CARD_ASPECT_RATIO),I=(a-l*this.COLS)/(this.COLS+1),f=(h-g*this.ROWS)/(this.ROWS+1),d=o+f;for(let u=s;u<n;u++){const C=u-s,A=Math.floor(C/this.COLS),w=C%this.COLS,v=I+w*(l+I),m=d+A*(g+f),b=this.createLevelCard(u,this.visibleLevels[u],l,g);b.position.set(v,m),t.addChild(b)}}createLevelCard(t,s,n,i){const r=new p,o=T.createShadow(n,i,0,8,.3);r.addChild(o);const a=T.createCardBackground(n,i,16777215);r.addChild(a);const h=this.createLevelThumbnail(s,n,i),c=new x;c.rect(0,0,n,i),c.fill(16777215),h.mask=c,r.addChild(c),r.addChild(h);const l=B.getInstance().getUserProfile()?.id;if(l&&s.authorId===l&&s.isPublished===!1){const v=new x;v.rect(0,0,n,i),v.fill({color:0,alpha:.2}),r.addChild(v);const m=new p,b=new x;let F="",y=0,M="#FFFFFF";s.authorPassed?(F=P.getInstance().t("status.draft"),y=8947848,M="#FFFFFF"):(F=P.getInstance().t("status.untested"),y=15658734,M="#888888");const V=e(24),U=e(12),_=e(20),L=new S({text:F,style:{fontFamily:"Arial",fontSize:e(12),fill:M,fontWeight:"bold"}}),H=Math.max(e(60),L.width+_);b.roundRect(0,0,H,V,U),b.fill(y),L.anchor.set(.5),L.position.set(H/2,V/2),m.addChild(b),m.addChild(L),m.position.set(e(10),e(10)),r.addChild(m)}else{const v=s.likes||0,m=new p,b=new S({text:v.toString(),style:{fontFamily:"Arial",fontSize:e(12),fill:"#FFFFFF",fontWeight:"bold"}}),F=e(10),y=e(14),M=e(4),V=F+y+M+b.width+F,U=e(24),_=e(12),L=new x;L.roundRect(0,0,V,U,_),L.fill({color:0,alpha:.4}),m.addChild(L);const H=T.createIcon("",y,"#FFFFFF");H.position.set(F+y/2,U/2+e(2)),m.addChild(H),b.anchor.set(0,.5),b.position.set(F+y+M,U/2),m.addChild(b),m.position.set(e(12),e(12)),r.addChild(m)}const g=e(25),I=[16739179,5164484,4569041,16760438,16742777,12246104],f=s.authorId||s.author||"unknown";let d=0;for(let v=0;v<f.length;v++)d=f.charCodeAt(v)+((d<<5)-d);const u=Math.abs(d)%I.length;let C=I[u],A;if(l&&s.authorId===l){const v=B.getInstance().getUserProfile();v&&(C=v.avatarColor,A=v.avatarUrl)}const w=T.createAvatar(g,A,C,16777215);return w.position.set(n-e(4),i-e(4)),w.eventMode="static",w.cursor="pointer",w.on("pointertap",v=>{v.stopPropagation(),this.showUserProfile(s,C)}),r.addChild(w),r.addChild(w),r.eventMode="static",r.cursor="pointer",r.on("pointertap",()=>{this.dragDistance<10&&this.onSelect(s)}),r}createLevelThumbnail(t,s,n){const i=new p,r=Math.min(s/yt,n/Pt);if(i.scale.set(r),t.obstacles&&t.obstacles.forEach(o=>i.addChild(vt.createVisual(o))),t.fallingObjects&&t.fallingObjects.forEach(o=>i.addChild(bt.createVisual(o))),t.nets&&t.nets.forEach(o=>i.addChild(It.createVisual(o))),t.iceBlocks&&t.iceBlocks.forEach(o=>i.addChild(At.createVisual(o))),t.lasers&&this.laserTexture&&t.lasers.forEach(o=>i.addChild(St.createVisual(o,this.laserTexture,14))),t.seesaws&&t.seesaws.forEach(o=>i.addChild(mt.createVisual(o))),t.conveyors&&t.conveyors.forEach(o=>i.addChild(Ft.createVisual(o))),t.buttons&&t.buttons.forEach(o=>i.addChild(Tt.createVisual(o))),t.balls){const o=dt.createVisual(t.balls.blue.x,t.balls.blue.y,"blue"),a=dt.createVisual(t.balls.pink.x,t.balls.pink.y,"pink");i.addChild(o),i.addChild(a)}return i}setupInteraction(){const t=k(),s=z(),n=this.getHeaderHeight();this.backgroundHitArea=new x,this.backgroundHitArea.rect(0,n,t,s-n),this.backgroundHitArea.fill({color:0,alpha:0}),this.addChildAt(this.backgroundHitArea,0),this.eventMode="static",this.on("pointerdown",i=>{if(this.penSelectionUI||this.userProfileCard||this.settingsUI)return;const r=this.getHeaderHeight();this.toLocal(i.global).y<r||(this.isDragging=!0,this.dragStartX=i.global.x,this.dragDistance=0,this.dragStartPageX=this.gridContainer.x)}),this.on("pointermove",i=>{if(!this.isDragging)return;const o=i.global.x-this.dragStartX;this.dragDistance=Math.max(this.dragDistance,Math.abs(o)),this.gridContainer.x=this.dragStartPageX+o}),this.on("pointerup",i=>this.endDrag(i)),this.on("pointerupoutside",i=>this.endDrag(i))}endDrag(t){if(!this.isDragging)return;this.isDragging=!1;const n=t.global.x-this.dragStartX;Math.abs(n)>50&&(n>0&&this.currentPage>0?this.currentPage--:n<0&&this.currentPage<this.totalPages-1&&this.currentPage++),this.scrollToPage(this.currentPage)}scrollToPage(t){const s=k(),n=-t*s,i=this.gridContainer.x,r=n-i,o=.3,a=Date.now(),h=++this.scrollTweenId,c=()=>{if(this.scrollTweenId!==h)return;const l=Date.now(),g=Math.min((l-a)/(o*1e3),1),I=1-Math.pow(1-g,3);this.gridContainer.x=i+r*I,g<1&&requestAnimationFrame(c)};c()}showPenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null),this.penSelectionUI=new xt(t=>{this.onPenSelect&&this.onPenSelect(t),this.currentPenId=t.id,this.closePenSelection()},()=>this.closePenSelection(),this.currentPenId),this.penSelectionUI.zIndex=1e3,this.addChild(this.penSelectionUI)}closePenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null)}showSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null),this.settingsUI=new Bt(()=>this.closeSettings()),this.settingsUI.zIndex=2e3,this.settingsUI.on("profileUpdate",()=>{B.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()})}),this.addChild(this.settingsUI)}closeSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null,B.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()}))}showUserProfile(t,s){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null);const n=this.levels.filter(i=>i.authorId===t.authorId&&i.isPublished).length;this.userProfileCard=new Lt(t,s,(i,r)=>this.createLevelThumbnail(t,i,r),()=>this.closeUserProfile(),i=>{this.closeUserProfile(),this.setFilterAuthor(i,t.author||"",s)},()=>{B.getInstance().toggleLike(t.id),this.setupGrid()},i=>{B.getInstance().deleteLevel(i),this.closeUserProfile(),this.levels=this.levels.filter(r=>r.id!==i),this.refreshVisibleLevels()},B.getInstance().getUserProfile()?.id===t.authorId,n),this.addChild(this.userProfileCard)}closeUserProfile(){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null)}setPen(t){this.currentPenId=t}setSortMode(t){const s=B.getInstance().getUserProfile()?.id;if(this.filterAuthorId&&this.filterAuthorId===s&&this.setFilterAuthor(null),this.sortMode===t&&this.filterAuthorId===null){this.currentPage!==0&&(this.currentPage=0,this.scrollToPage(0));return}this.sortMode=t,this.updateSortButtons(),this.refreshVisibleLevels()}setFilterAuthor(t,s,n){if(this.filterAuthorId!==t){if(this.filterAuthorId=t,t){this.filterAuthorName=s||`User ${t.slice(0,4)}`,this.filterAuthorColor=n||8947848;const i=B.getInstance().getUserProfile()?.id;i&&t===i&&(this.sortMode="latest")}else this.filterAuthorName=null;this.updateSortButtons(),this.updateFilterTag(),this.refreshVisibleLevels()}}updateFilterTag(){if(!this.filterFilterTagContainer)return;this.filterFilterTagContainer.removeChildren();const t=B.getInstance().getUserProfile()?.id;if(!this.filterAuthorId||t&&this.filterAuthorId===t){this.filterFilterTagContainer.visible=!1;return}this.filterFilterTagContainer.visible=!0;const s=e(40),n=e(6),i=e(12),r=e(8),o=e(28),a=e(16),h=e(14),c=16777215,l=14737632,g=3355443,I=10066329,f=16119285,d=new x,u=new x;u.circle(0,0,o/2),u.fill(this.filterAuthorColor),u.position.set(n+o/2,s/2);const C=new S({text:this.filterAuthorName||"Unknown",style:{fontFamily:"Arial",fontSize:a,fill:g,fontWeight:"bold"}});C.anchor.set(0,.5),C.position.set(n+o+r,s/2);const A=new S({text:"✕",style:{fontFamily:"Arial",fontSize:e(14),fill:I,fontWeight:"bold"}});A.anchor.set(.5);const w=n+o+r+C.width+r+h+i;d.roundRect(0,0,w,s,s/2),d.fill(c),d.stroke({width:1,color:l}),A.position.set(w-i-h/2,s/2),this.filterFilterTagContainer.addChild(d),this.filterFilterTagContainer.addChild(u),this.filterFilterTagContainer.addChild(C),this.filterFilterTagContainer.addChild(A);const v=k(),b=(z()*this.HEADER_HEIGHT_RATIO+e(10))/2;if(this.mineBtnText)this.filterFilterTagContainer.x=this.mineBtnText.x+this.mineBtnText.width+e(30);else{const F=v/2;this.filterFilterTagContainer.x=F+e(200)}this.filterFilterTagContainer.y=b-s/2,this.filterFilterTagContainer.eventMode="static",this.filterFilterTagContainer.cursor="pointer",this.filterFilterTagContainer.on("pointerover",()=>{d.clear(),d.roundRect(0,0,w,s,s/2),d.fill(f),d.stroke({width:1,color:l})}),this.filterFilterTagContainer.on("pointerout",()=>{d.clear(),d.roundRect(0,0,w,s,s/2),d.fill(c),d.stroke({width:1,color:l})}),this.filterFilterTagContainer.on("pointertap",()=>{this.setFilterAuthor(null)})}refreshVisibleLevels(){let t=this.levels;const s=this.filterAuthorId,n=B.getInstance().getUserProfile()?.id;n&&s===n?t=t.filter(i=>i.authorId===s):s?t=t.filter(i=>(i.authorId===s||!i.authorId&&s.startsWith("mock_user"))&&i.isPublished!==!1):t=t.filter(i=>i.isPublished!==!1),t=[...t],this.sortMode==="popular"?t.sort((i,r)=>(r.likes||0)-(i.likes||0)):t.sort((i,r)=>(r.createdAt||0)-(i.createdAt||0)),this.visibleLevels=t,this.scrollTweenId++,this.currentPage=0,this.totalPages=Math.ceil(this.visibleLevels.length/this.ITEMS_PER_PAGE),this.totalPages===0&&(this.totalPages=1),this.gridContainer.x=0,this.setupGrid()}updateLayout(){this.headerContainer.removeChildren(),this.createLevelBtn&&(this.removeChild(this.createLevelBtn),this.createLevelBtn.destroy({children:!0}),this.createLevelBtn=void 0),this.backgroundHitArea&&(this.removeChild(this.backgroundHitArea),this.backgroundHitArea.destroy(),this.backgroundHitArea=null),this.setupHeader(),this.setupGrid(),this.setupInteraction(),this.currentPage>=this.totalPages&&(this.currentPage=Math.max(0,this.totalPages-1)),this.gridContainer.x=-this.currentPage*k(),this.penSelectionUI,this.userProfileCard}updateLevels(t){this.levels=t,this.refreshVisibleLevels()}}export{Wt as LevelSelectionUI};
